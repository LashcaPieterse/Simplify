# Prometheus alerting rules for Airalo integration
# Load this file into your Alertmanager/Prometheus stack.

groups:
  - name: airalo
    rules:
      - alert: AiraloOrderErrorSpike
        expr: sum by(reason) (increase(airalo_order_requests_total{result="error"}[5m])) > 5
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "High error rate when creating Airalo orders"
          description: |
            More than five order creation failures were observed in the last five minutes.
            Inspect structured logs (event=airalo.order.create.failed) for the failing Airalo request IDs.

      - alert: AiraloWebhookFailure
        expr: increase(airalo_webhook_events_total{result="error"}[5m]) > 0
        for: 5m
        labels:
          severity: high
        annotations:
          summary: "Airalo webhook failures detected"
          description: |
            The webhook handler returned errors in the last five minutes.
            Check the WebhookEvent table and logs for event details.

      - alert: AiraloRateLimitBreaching
        expr: increase(airalo_rate_limit_events_total[10m]) > 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Rate limit responses observed"
          description: |
            Airalo responded with 429 or Prisma reported contention.
            Consider backing off request volume or contacting Airalo support.

      - alert: PublicApiFiveHundreds
        expr: sum(increase(nextjs_api_requests_total{status=~"5.."}[5m])) > 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Repeated 5xx responses from Next.js API routes"
          description: |
            Investigate /api/orders and /api/airalo/webhooks endpoints for errors.
            Refer to the Airalo runbook for mitigation guidance.

      - alert: AiraloPackageSyncFailures
        expr: increase(airalo_package_sync_runs_total{result="failure"}[15m]) > 0
        for: 15m
        labels:
          severity: high
        annotations:
          summary: "Airalo package sync job is failing"
          description: |
            The scheduled package sync has reported failures in the last 15 minutes.
            Check the airalo-package-sync CronJob logs and restart the job if needed.

      - alert: AiraloPackageSyncStale
        expr: (time() - airalo_package_sync_last_success_timestamp > 3600)
          and airalo_package_sync_last_success_timestamp > 0
        for: 10m
        labels:
          severity: high
        annotations:
          summary: "Airalo packages have not been synced in the last hour"
          description: |
            The syncAiraloPackages job has not reported a successful run within 60 minutes.
            Ensure the hourly sync is scheduled and inspect the worker logs for failures.
