generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Country {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  countryCode String     @unique @map("country_code")
  name        String
  slug        String     @unique
  imageUrl    String?    @map("image_url")
  metadata    Json?      @default(dbgenerated("'{}'::jsonb"))
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @default(now()) @updatedAt @map("updated_at")
  operators   Operator[]
  packages    Package[]

  @@map("countries")
}

model Operator {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  country       Country   @relation(fields: [countryId], references: [id], onDelete: Restrict)
  countryId     String    @map("country_id") @db.Uuid
  name          String
  apiOperatorId Int?      @map("api_operator_id")
  operatorCode  String?   @map("operator_code")
  metadata      Json?     @default(dbgenerated("'{}'::jsonb"))
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")
  packages      Package[]

  @@index([countryId])
  @@map("operators")
}

model Package {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  country            Country  @relation(fields: [countryId], references: [id], onDelete: Restrict)
  countryId          String   @map("country_id") @db.Uuid
  operator           Operator @relation(fields: [operatorId], references: [id], onDelete: Restrict)
  operatorId         String   @map("operator_id") @db.Uuid
  externalId         String   @map("external_id") @unique
  name               String
  dataAmountMb       Int?     @map("data_amount_mb")
  validityDays       Int?     @map("validity_days")
  isUnlimited        Boolean  @default(false) @map("is_unlimited")
  priceCents         Int      @map("price_cents")
  sellingPriceCents  Int?     @map("selling_price_cents")
  currencyCode       String   @default("USD") @map("currency_code")
  shortInfo          String?  @map("short_info")
  qrInstallation     String?  @map("qr_installation")
  manualInstallation String?  @map("manual_installation")
  isFairUsagePolicy  Boolean? @map("is_fair_usage_policy")
  fairUsagePolicy    String?  @map("fair_usage_policy")
  imageUrl           String?  @map("image_url")
  metadata           Json?    @default(dbgenerated("'{}'::jsonb"))
  isActive           Boolean  @default(true) @map("is_active")
  deactivatedAt      DateTime? @map("deactivated_at")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([countryId])
  @@index([operatorId])
  @@map("packages")
}

model AiraloPackage {
  id                String             @id @default(cuid())
  externalId        String             @unique
  name              String
  description       String?
  country           String?
  countryCode       String?
  region            String?
  dataLimitMb       Int?
  validityDays      Int?
  priceCents        Int
  currency          String
  sellingPriceCents Int?
  metadata          Json?
  lastSyncedAt      DateTime?
  sourceHash        String?
  isActive          Boolean            @default(true)
  deactivatedAt     DateTime?
  lastSyncJob       SyncJob?           @relation(fields: [lastSyncJobId], references: [id])
  lastSyncJobId     String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  esimOrders        EsimOrder[]
  checkoutSessions  CheckoutSession[]
  tags              AiraloPackageTag[]
  notes             PackageNote[]
}

model EsimOrder {
  id                   String                     @id @default(cuid())
  orderNumber          String?                    @unique
  requestId            String?                    @unique
  package              AiraloPackage              @relation(fields: [packageId], references: [id])
  packageId            String
  status               String                     @default("pending")
  customerEmail        String?
  quantity             Int                        @default(1)
  totalCents           Int?
  currency             String?
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  profiles             EsimProfile[]
  usageSnapshots       UsageSnapshot[]
  webhookEvents        WebhookEvent[]
  installation         EsimInstallationPayload?
  payment              PaymentTransaction?        @relation(fields: [paymentTransactionId], references: [id])
  paymentTransactionId String?
  recoveryAttempts     EsimOrderRecoveryAttempt[]
}

model EsimProfile {
  id             String          @id @default(cuid())
  iccid          String          @unique
  imsi           String?
  activationCode String?
  status         String
  order          EsimOrder       @relation(fields: [orderId], references: [id])
  orderId        String
  expiresAt      DateTime?
  activatedAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  usageSnapshots UsageSnapshot[]
}

model UsageSnapshot {
  id          String      @id @default(cuid())
  profile     EsimProfile @relation(fields: [profileId], references: [id])
  profileId   String
  order       EsimOrder   @relation(fields: [orderId], references: [id])
  orderId     String
  usedMb      Float?
  remainingMb Float?
  recordedAt  DateTime    @default(now())
}

model WebhookEvent {
  id          String     @id @default(cuid())
  eventId     String     @unique
  eventType   String
  order       EsimOrder? @relation(fields: [orderId], references: [id])
  orderId     String?
  /// Raw JSON payload returned by the upstream webhook.
  ///
  /// Stored as a string because the SQLite connector used in development
  /// does not support the Prisma `Json` type.
  payload     String
  createdAt   DateTime   @default(now())
  processedAt DateTime?
}

model EsimOrderRecoveryAttempt {
  id         String    @id @default(cuid())
  order      EsimOrder @relation(fields: [orderId], references: [id])
  orderId    String
  identifier String
  result     String
  reason     String?
  createdAt  DateTime  @default(now())
}

model EsimInstallationPayload {
  id        String    @id @default(cuid())
  order     EsimOrder @relation(fields: [orderId], references: [id])
  orderId   String    @unique
  payload   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model CheckoutSession {
  id              String               @id @default(cuid())
  package         AiraloPackage        @relation(fields: [packageId], references: [id])
  packageId       String
  customerEmail   String?
  quantity        Int                  @default(1)
  totalCents      Int
  currency        String
  status          String               @default("pending")
  intent          String               @default("purchase")
  topUpForOrderId String?
  topUpForIccid   String?
  orderId         String?
  metadata        String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  payments        PaymentTransaction[]
}

model PaymentTransaction {
  id                String                    @id @default(cuid())
  provider          String
  providerReference String?
  transactionToken  String?
  redirectUrl       String?
  status            String                    @default("pending")
  amountCents       Int
  currency          String
  statusHistory     String?
  metadata          String?
  checkout          CheckoutSession?          @relation(fields: [checkoutId], references: [id])
  checkoutId        String?
  orders            EsimOrder[]
  webhookEvents     PaymentTransactionEvent[]
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
}

model PaymentTransactionEvent {
  id            String             @id @default(cuid())
  transaction   PaymentTransaction @relation(fields: [transactionId], references: [id])
  transactionId String
  eventType     String
  payload       String
  receivedAt    DateTime           @default(now())
}

model AiraloAccessToken {
  key       String   @id
  token     String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AdminUser {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  name         String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  auditLogs    AuditLog[]
  notes        PackageNote[]
}

model SyncJob {
  id               String          @id @default(cuid())
  status           String          @default("pending")
  startedAt        DateTime        @default(now())
  finishedAt       DateTime?
  itemsCreated     Int             @default(0)
  itemsUpdated     Int             @default(0)
  itemsDeactivated Int             @default(0)
  diffPreview      String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  packages         AiraloPackage[]
}

model PackageTag {
  id        String             @id @default(cuid())
  name      String             @unique
  color     String?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  packages  AiraloPackageTag[]
}

model AiraloPackageTag {
  package   AiraloPackage @relation(fields: [packageId], references: [id])
  packageId String
  tag       PackageTag    @relation(fields: [tagId], references: [id])
  tagId     String

  @@id([packageId, tagId])
}

model PackageNote {
  id        String        @id @default(cuid())
  package   AiraloPackage @relation(fields: [packageId], references: [id])
  packageId String
  author    AdminUser?    @relation(fields: [authorId], references: [id])
  authorId  String?
  body      String
  createdAt DateTime      @default(now())
}

model AuditLog {
  id         String     @id @default(cuid())
  actor      AdminUser? @relation(fields: [actorId], references: [id])
  actorId    String?
  action     String
  entityType String
  entityId   String
  details    String?
  createdAt  DateTime   @default(now())
}
