generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model AiraloPackage {
  id           String      @id @default(cuid())
  externalId   String      @unique
  name         String
  description  String?
  region       String?
  dataLimitMb  Int?
  validityDays Int?
  priceCents   Int
  currency     String
  metadata     String?
  lastSyncedAt DateTime?
  sourceHash   String?
  isActive     Boolean     @default(true)
  deactivatedAt DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  esimOrders   EsimOrder[]
  checkoutSessions CheckoutSession[]
}

model EsimOrder {
  id             String                   @id @default(cuid())
  orderNumber    String?                  @unique
  requestId      String?                  @unique
  package        AiraloPackage            @relation(fields: [packageId], references: [id])
  packageId      String
  status         String                   @default("pending")
  customerEmail  String?
  quantity       Int      @default(1)
  totalCents     Int?
  currency       String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  profiles       EsimProfile[]
  usageSnapshots UsageSnapshot[]
  webhookEvents  WebhookEvent[]
  installation   EsimInstallationPayload?
  payment        PaymentTransaction?      @relation(fields: [paymentTransactionId], references: [id])
  paymentTransactionId String?
}

model EsimProfile {
  id             String          @id @default(cuid())
  iccid          String          @unique
  imsi           String?
  activationCode String?
  status         String
  order          EsimOrder       @relation(fields: [orderId], references: [id])
  orderId        String
  expiresAt      DateTime?
  activatedAt    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  usageSnapshots UsageSnapshot[]
}

model UsageSnapshot {
  id          String      @id @default(cuid())
  profile     EsimProfile @relation(fields: [profileId], references: [id])
  profileId   String
  order       EsimOrder   @relation(fields: [orderId], references: [id])
  orderId     String
  usedMb      Float?
  remainingMb Float?
  recordedAt  DateTime    @default(now())
}

model WebhookEvent {
  id          String     @id @default(cuid())
  eventId     String     @unique
  eventType   String
  order       EsimOrder? @relation(fields: [orderId], references: [id])
  orderId     String?
  /// Raw JSON payload returned by the upstream webhook.
  ///
  /// Stored as a string because the SQLite connector used in development
  /// does not support the Prisma `Json` type.
  payload     String
  createdAt   DateTime   @default(now())
  processedAt DateTime?
}

model EsimInstallationPayload {
  id        String    @id @default(cuid())
  order     EsimOrder @relation(fields: [orderId], references: [id])
  orderId   String    @unique
  payload   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model CheckoutSession {
  id                String               @id @default(cuid())
  package           AiraloPackage        @relation(fields: [packageId], references: [id])
  packageId         String
  customerEmail     String?
  quantity          Int                  @default(1)
  totalCents        Int
  currency          String
  status            String               @default("pending")
  intent            String               @default("purchase")
  topUpForOrderId   String?
  topUpForIccid     String?
  orderId           String?
  metadata          String?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  payments          PaymentTransaction[]
}

model PaymentTransaction {
  id                String               @id @default(cuid())
  provider          String
  providerReference String?
  transactionToken  String?
  redirectUrl       String?
  status            String               @default("pending")
  amountCents       Int
  currency          String
  statusHistory     String?
  metadata          String?
  checkout          CheckoutSession?     @relation(fields: [checkoutId], references: [id])
  checkoutId        String?
  orders            EsimOrder[]
  webhookEvents     PaymentTransactionEvent[]
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
}

model PaymentTransactionEvent {
  id                 String             @id @default(cuid())
  transaction        PaymentTransaction @relation(fields: [transactionId], references: [id])
  transactionId      String
  eventType          String
  payload            String
  receivedAt         DateTime           @default(now())
}

model AiraloAccessToken {
  key       String   @id
  token     String
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
